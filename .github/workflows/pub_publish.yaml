name: pub_publish

on:
  push:
    tags:
      - '([a-z_]+)-v\d+.\d+.\d+(?:[a-z.\-+\d]+){0,1}'

jobs:
  to_publish:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: read

    outputs:
      package: ${{ steps.package.outputs.package }}
      action: ${{ steps.action.outputs.action }}

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v3

      - name: ğŸ“¦ Finding a package to publish
        id: package
        run: |
          tag=${GITHUB_REF#refs/*/}
          package=$(echo $tag | sed -En "s/^(.*)-v(.*)/\1/p")
          if [[ -d "packages/$package" ]]; then
            echo "::set-output name=package::${package}"
          fi

      - name: ğŸ’¥ Finding an action to publish
        id: action
        if: steps.package.outputs.package == ''
        run: |
          tag=${GITHUB_REF#refs/*/}
          action=$(echo $tag | sed -En "s/^(.*)-v(.*)/\1/p")
          if [[ -d "actions/$action" ]]; then
            echo "::set-output name=action::${action}"
          fi

  failed_to_find:
    needs: to_publish
    if: needs.to_publish.outputs.package != '' && needs.to_publish.outputs.action != ''
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ˜¢ No package or action found
        run: exit 1

  publish_package:
    needs: to_publish
    if: needs.to_publish.outputs.package != ''
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: packages/${{ needs.to_publish.outputs.package }}

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v3

      - name: ğŸ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ğŸ“¦ Get Dependencies
        run: dart pub get

      - name: ğŸ” Setup Pub Credentials
        run: |
          mkdir -p $XDG_CONFIG_HOME/dart
          echo '${{ secrets.PUB_CREDENTIALS }}' > "$XDG_CONFIG_HOME/dart/pub-credentials.json"

      - name: ğŸŒµ Dry Run
        run: dart pub publish --dry-run

      - name: ğŸ“¢ Publish
        run: dart pub publish -f
  
  publish_action:
    needs: to_publish
    if: needs.to_publish.outputs.action != ''
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: actions/${{ needs.to_publish.outputs.action }}

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v3

      - name: ğŸ¯ Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ğŸ“¦ Get Dependencies
        run: dart pub get

      - name: ğŸ” Setup Pub Credentials
        run: |
          mkdir -p $XDG_CONFIG_HOME/dart
          echo '${{ secrets.PUB_CREDENTIALS }}' > "$XDG_CONFIG_HOME/dart/pub-credentials.json"

      - name: ğŸŒµ Dry Run
        run: dart pub publish --dry-run

      - name: ğŸ“¢ Publish
        run: dart pub publish -f