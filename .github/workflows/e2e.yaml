name: e2e

on:
  pull_request:
    branches:
      - main

defaults:
  run:
    working-directory: example

jobs:
  flows:
    runs-on: ubuntu-latest

    outputs:
      flows: ${{ steps.flows.outputs.flows }}

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v3

      - name: ğŸ“¦ Finding a package to publish
        id: package
        run: |
          flows="["
          for flow in ./flows/*.yaml; do
            flows="$flows\"$(basename $flow .yaml)\","
          done

          # Remove last "," and add the closing bracket
          if [[ $flows == *, ]]; then
              flows="${flows%?}"
          fi
          flows="$flows]"

          echo "flows=$( echo "$flows" )" >> $GITHUB_OUTPUT

  ios:
    needs: flows

    strategy:
      matrix:
        package: ${{ fromJSON(needs.flows.outputs.flows) }}
      fail-fast: true

    runs-on: macos-latest

    steps:
      - name: ğŸ“š Git Checkout
        uses: actions/checkout@v3

      - name: ğŸ¦ Setup Local Fluttium Environment
        uses: ./.github/actions/local_fluttium_environment

      - name: ğŸ“¦ Installing packages
        run: |
          flutter pub get
          cd ios && pod install && cd ..

      - name: ğŸ”§ Setting Up Simulator
        id: simulator
        uses: futureware-tech/simulator-action@v2
        with:
          model: 'iPhone 11'

      - name: ğŸ§ª Testing
        run: fluttium test --flavor development --target lib/main_development.dart -d ${{ steps.simulator.outputs.udid }} flows/${{ matrix.test_file }}.yaml

  # macos:
  #   needs: flows

  #   strategy:
  #     matrix:
  #       package: ${{ fromJSON(needs.flows.outputs.flows) }}
  #     fail-fast: true

  #   runs-on: macos-latest

  #   steps:
  #     - name: ğŸ“š Git Checkout
  #       uses: actions/checkout@v3

  #     - name: ğŸ¦ Setup Local Fluttium Environment
  #       uses: ./.github/actions/local_fluttium_environment

  #     - name: ğŸ“¦ Installing packages
  #       run: |
  #         flutter pub get
  #         cd macos && pod install && cd ..

  #     - name: ğŸ§ª Testing
  #       run: fluttium test -d macos flows/${{ matrix.test_file }}.yaml

  # android:
  #   strategy:
  #     matrix:
  #       test_file:
  #         - flows/text_flow.yaml
  #     fail-fast: true

  #   runs-on: macos-latest

  #   steps:
  #     - name: ğŸ“š Git Checkout
  #       uses: actions/checkout@v3

  #     - name: ğŸ¦ Setup Flutter
  #       uses: subosito/flutter-action@v2
  #       with:
  #         channel: stable
  #         cache: true

  #     - name: ğŸ“¦ Installing packages
  #       run: |
  #         flutter pub get
  #         dart pub global activate --source path ../packages/fluttium_cli

  #     - name: ğŸ§ª Testing
  #       uses: reactivecircus/android-emulator-runner@v2
  #       with:
  #         api-level: 29
  #         arch: x86_64
  #         profile: Nexus 6
  #         script: fluttium test ${{ matrix.test_file }}
